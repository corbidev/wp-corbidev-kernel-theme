#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * CorbiDev Kernel CLI
 *
 * Outil d’outillage (doc / CI).
 * ❌ Jamais utilisé par WordPress
 * ❌ Aucun rendu HTML
 * ✅ Réutilise les validateurs du Kernel
 */

require_once __DIR__ . '/../vendor/autoload.php';

use CorbiDev\Theme\Config\ConfigSchema;
use CorbiDev\Theme\Config\ConfigExporter;
use CorbiDev\Theme\Kernel;

$argv = $_SERVER['argv'] ?? [];
$command = $argv[1] ?? null;

if ($command === null) {
	fwrite(STDERR, "Missing command.\n");
	exit(1);
}

try {
	switch ($command) {
		case 'export:config':
			$configPath = $argv[2] ?? null;

			if ($configPath === null || !is_file($configPath)) {
				throw new RuntimeException('Config file path is required.');
			}

			/** @var array $config */
			$config = require $configPath;

			if (!\is_array($config)) {
				throw new RuntimeException('Config file must return an array.');
			}

			$schema = new ConfigSchema();

			$kernelVersion = getKernelVersion();
			$environment = getenv('KERNEL_ENV') ?: 'ci';

			$validatedConfig = $schema->validate($config, $kernelVersion, $environment);

			$json = ConfigExporter::toJson($validatedConfig);

			fwrite(STDOUT, $json . PHP_EOL);
			exit(0);

		case 'scan:regressions':
			// volontairement simple : outillage CI uniquement
			fwrite(STDOUT, "Regression scan not implemented yet.\n");
			exit(0);

		default:
			throw new RuntimeException('Unknown command: ' . $command);
	}
} catch (Throwable $e) {
	fwrite(STDERR, '[Kernel CLI] ' . $e->getMessage() . PHP_EOL);
	exit(1);
}

function getKernelVersion(): string
{
	try {
		$reflection = new ReflectionClass(Kernel::class);
		$constant = $reflection->getReflectionConstant('VERSION');

		if ($constant === false) {
			throw new RuntimeException('Kernel VERSION constant not found.');
		}

		$value = $constant->getValue();

		if (!\is_string($value) || $value === '') {
			throw new RuntimeException('Kernel VERSION constant is invalid.');
		}

		return $value;
	} catch (Throwable $e) {
		throw new RuntimeException('Unable to determine Kernel version.', 0, $e);
	}
}